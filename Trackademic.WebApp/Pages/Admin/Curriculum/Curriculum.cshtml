@page
@model Trackademic.WebApp.Pages.Admin.Curriculum.CurriculumModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Curriculum Manager";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    .dashboard-page { height: calc(100vh - 60px); overflow: hidden; display: flex; flex-direction: column; }
    .dashboard-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
    .management-page { display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 0 auto; }
    
    .section-container { border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); background-color: #fff; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .section-header h2 { font-size: 1.25rem; margin: 0; color: #333; }
    
    .list-container { display: flex; flex-direction: column; gap: 6px; }
    .item-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 4px; cursor: pointer; background-color: #fff; transition: background-color 0.1s; }
    .item-card:hover:not(.active) { background-color: #f8f9fa; }
    .item-card.active { background-color: #e9ecef; border-color: #007bff; font-weight: bold; }
    
    .add-btn { padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white; font-size: 0.9rem; }
    .icon-buttons { display: flex; gap: 5px; }
    .icon-button { background: none; border: none; cursor: pointer; color: #6c757d; padding: 0 5px; font-size: 0.9em; }
    .teacher-badge { background-color: #28a745; color: white; padding: 3px 6px; border-radius: 3px; font-size: 0.75rem; }
    .add-form-container { padding: 10px; border: 1px dashed #ccc; border-radius: 4px; margin-top: 10px; background-color: #fdfdfd; }
    
    .editable-name { cursor: pointer; flex-grow: 1; }
    .editing .editable-name { display: none; }
    .editing .edit-form { display: block; }
    .edit-form { display: none; width: 100%; }
    .w-auto { width: auto !important; }
</style>

<div class="dashboard-page">
    <div class="dashboard-container">
        <div class="management-page">
            
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fa-solid fa-check-circle me-2"></i> @TempData["Message"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i> <strong>Invalid Input:</strong> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            
            @* Client-Side JS Error Box *@
            <div id="js-error" class="alert alert-danger d-none" role="alert">
                <i class="fa-solid fa-triangle-exclamation me-2"></i> <span id="js-error-text"></span>
            </div>

            <section class="section-container" id="sy-section">
                <div class="section-header">
                    <h2>School Years</h2>
                    <button class="add-btn" data-type="Year"><i class="fa-solid fa-plus"></i> Add Year</button>
                </div>
                <div class="add-form-container d-none" id="add-form-Year">
                    <form method="post" asp-page-handler="CreateYear" onsubmit="return validateYear(this)">
                        <input type="text" name="YearName" class="form-control mb-2" placeholder="2024-2025" pattern="\d{4}-\d{4}" required />
                        <div class="d-flex gap-2 mb-2">
                            <input type="date" name="DateStarted" class="form-control" required />
                            <input type="date" name="DateEnded" class="form-control" required />
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add">Cancel</button>
                    </form>
                </div>
                <div class="list-container">
                    @foreach (var year in Model.YearList)
                    {
                        <div class="item-card @(Model.SelectedYearId == year.Id ? "active" : "")" 
                            data-id="@year.Id" data-type="Year">
                            <span class="editable-name">@year.YearName</span>
                            <div class="edit-form">
                                <form method="post" asp-page-handler="EditYear" class="d-flex align-items-center gap-2" onsubmit="return validateYear(this)">
                                    <input type="hidden" name="id" value="@year.Id" />
                                    <input type="text" name="YearName" value="@year.YearName" class="form-control form-control-sm" pattern="\d{4}-\d{4}" required />
                                    <input type="date" name="DateStarted" value="@(year.DateStarted?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm w-auto" required />
                                    <input type="date" name="DateEnded" value="@(year.DateEnded?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm w-auto" required />
                                    <button type="submit" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-edit"><i class="fa-solid fa-xmark"></i></button>
                                </form>
                            </div>
                            <div class="icon-buttons">
                                <button class="icon-button edit-btn"><i class="fa-solid fa-pen"></i></button>
                                <button class="icon-button delete-btn" data-id="@year.Id" data-handler="DeleteYear"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    }
                </div>
            </section>
            
            <section class="section-container" id="sem-section">
                <div class="section-header">
                    <h2>Semesters</h2>
                    <button class="add-btn" data-type="Semester" @(Model.SelectedYearId == 0 ? "disabled" : "")><i class="fa-solid fa-plus"></i> Add Semester</button>
                </div>
                <div class="add-form-container d-none" id="add-form-Semester">
                    <form method="post" asp-page-handler="CreateSemester" onsubmit="return validateDates(this)">
                        <input type="hidden" name="SchoolYearId" value="@Model.SelectedYearId" />
                        <input type="text" name="SemesterName" class="form-control mb-2" placeholder="e.g., 1st Semester" required minlength="2" />
                        <div class="d-flex gap-2 mb-2">
                            <input type="date" name="DateStarted" class="form-control" required />
                            <input type="date" name="DateEnded" class="form-control" required />
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add">Cancel</button>
                    </form>
                </div>
                <div class="list-container">
                    @if (Model.SelectedYearId > 0) {
                        @foreach (var semester in Model.SemesterList) {
                            <div class="item-card @(Model.SelectedSemesterId == semester.Id ? "active" : "")" 
                                data-id="@semester.Id" data-type="Semester">
                                <span class="editable-name">@semester.SemesterName</span>
                                <div class="edit-form">
                                    <form method="post" asp-page-handler="EditSemester" class="d-flex align-items-center gap-2" onsubmit="return validateDates(this)">
                                        <input type="hidden" name="id" value="@semester.Id" />
                                        <input type="text" name="SemesterName" value="@semester.SemesterName" class="form-control form-control-sm" required minlength="2" />
                                        <input type="date" name="DateStarted" value="@(semester.DateStarted?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm w-auto" required />
                                        <input type="date" name="DateEnded" value="@(semester.DateEnded?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm w-auto" required />
                                        <button type="submit" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                        <button type="button" class="btn btn-sm btn-secondary cancel-edit"><i class="fa-solid fa-xmark"></i></button>
                                    </form>
                                </div>
                                <div class="icon-buttons">
                                    <button class="icon-button edit-btn"><i class="fa-solid fa-pen"></i></button>
                                    <button class="icon-button delete-btn" data-id="@semester.Id" data-handler="DeleteSemester"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        }
                    } else { <p class="text-muted">Select a School Year above.</p> }
                </div>
            </section>
            
            <section class="section-container" id="dept-section">
                <div class="section-header">
                    <h2>Departments</h2>
                    <button class="add-btn" data-type="Department"><i class="fa-solid fa-plus"></i> Add Department</button>
                </div>
                <div class="add-form-container d-none" id="add-form-Department">
                    <form method="post" asp-page-handler="CreateDepartment" onsubmit="return validateText(this, 'DeptName')">
                        <input type="text" name="DeptName" class="form-control mb-2" placeholder="e.g., Computer Engineering" required minlength="2" />
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add">Cancel</button>
                    </form>
                </div>
                <div class="list-container">
                    @foreach (var department in Model.DepartmentList) {
                        <div class="item-card @(Model.SelectedDepartmentId == department.Id ? "active" : "")" 
                            data-id="@department.Id" data-type="Department">
                            <span class="editable-name">@department.DeptName</span>
                            <div class="edit-form">
                                <form method="post" asp-page-handler="EditDepartment" class="d-flex align-items-center gap-2" onsubmit="return validateText(this, 'DeptName')">
                                    <input type="hidden" name="id" value="@department.Id" />
                                    <input type="text" name="DeptName" value="@department.DeptName" class="form-control form-control-sm" required minlength="2" />
                                    <button type="submit" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-edit"><i class="fa-solid fa-xmark"></i></button>
                                </form>
                            </div>
                            <div class="icon-buttons">
                                <button class="icon-button edit-btn"><i class="fa-solid fa-pen"></i></button>
                                <button class="icon-button delete-btn" data-id="@department.Id" data-handler="DeleteDepartment"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    }
                </div>
            </section>

            <section class="section-container" id="subj-section">
                <div class="section-header">
                    <h2>Subjects</h2>
                    <button class="add-btn" data-type="Subject" @(Model.SelectedDepartmentId == 0 ? "disabled" : "")><i class="fa-solid fa-plus"></i> Add Subject</button>
                </div>
                <div class="add-form-container d-none" id="add-form-Subject">
                    <form method="post" asp-page-handler="CreateSubject">
                        <input type="hidden" name="DepartmentId" value="@Model.SelectedDepartmentId" />
                        <input type="text" name="SubjectCode" class="form-control mb-2" placeholder="Code (e.g., CPE 101)" required minlength="2" />
                        <input type="text" name="SubjectName" class="form-control mb-2" placeholder="Title (e.g., Logic Circuits)" required minlength="2" />
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add">Cancel</button>
                    </form>
                </div>
                <div class="list-container">
                    @if (Model.SelectedDepartmentId > 0) {
                        @if (Model.SubjectList.Any()) {
                            @foreach (var subject in Model.SubjectList) {
                                <div class="item-card @(Model.SelectedSubjectId == subject.Id ? "active" : "")" 
                                    data-id="@subject.Id" data-type="Subject">
                                    <span class="editable-name">@subject.SubjectCode - @subject.SubjectName</span>
                                    <div class="edit-form">
                                        <form method="post" asp-page-handler="EditSubject" class="d-flex align-items-center gap-2">
                                            <input type="hidden" name="id" value="@subject.Id" />
                                            <input type="text" name="SubjectCode" value="@subject.SubjectCode" class="form-control form-control-sm w-auto" required />
                                            <input type="text" name="SubjectName" value="@subject.SubjectName" class="form-control form-control-sm" required />
                                            <button type="submit" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                            <button type="button" class="btn btn-sm btn-secondary cancel-edit"><i class="fa-solid fa-xmark"></i></button>
                                        </form>
                                    </div>
                                    <div class="icon-buttons">
                                        <button class="icon-button edit-btn"><i class="fa-solid fa-pen"></i></button>
                                        <button class="icon-button delete-btn" data-id="@subject.Id" data-handler="DeleteSubject"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            }
                        } else { <p class="text-muted">No subjects found.</p> }
                    } else { <p class="text-muted">Select a Department above.</p> }
                </div>
            </section>

            <section class="section-container" id="class-section">
                <div class="section-header">
                    <h2>Classes</h2>
                    <button class="add-btn" data-type="Class" @(Model.SelectedSubjectId == 0 || Model.SelectedSemesterId == 0 ? "disabled" : "")><i class="fa-solid fa-plus"></i> Add Class</button>
                </div>
                <div class="add-form-container d-none" id="add-form-Class">
                    <form method="post" asp-page-handler="CreateClass">
                        <input type="hidden" name="YearId" value="@Model.SelectedYearId" />
                        <input type="hidden" name="SemesterId" value="@Model.SelectedSemesterId" />
                        <input type="hidden" name="SubjectId" value="@Model.SelectedSubjectId" />
                        <input type="text" name="ClassSection" class="form-control mb-2" placeholder="Section (e.g., CPE-1A)" required />
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add">Cancel</button>
                    </form>
                </div>
                <div class="list-container">
                    @if (Model.SelectedYearId > 0 && Model.SelectedSemesterId > 0 && Model.SelectedSubjectId > 0) {
                        @if (Model.ClassList.Any()) {
                            @foreach (var classItem in Model.ClassList) {
                                <div class="item-card @(Model.SelectedClassId == classItem.Id ? "active" : "")" 
                                    data-id="@classItem.Id" data-type="Class">
                                    <span class="editable-name">@classItem.ClassSection</span>
                                    <div class="edit-form">
                                        <form method="post" asp-page-handler="EditClass" class="d-flex align-items-center gap-2">
                                            <input type="hidden" name="id" value="@classItem.Id" />
                                            <input type="text" name="ClassSection" value="@classItem.ClassSection" class="form-control form-control-sm" required />
                                            <button type="submit" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                            <button type="button" class="btn btn-sm btn-secondary cancel-edit"><i class="fa-solid fa-xmark"></i></button>
                                        </form>
                                    </div>
                                    <div class="icon-buttons">
                                        <span class="teacher-badge">@classItem.AssignedTeacherName</span>
                                        <button class="icon-button edit-btn"><i class="fa-solid fa-pen"></i></button>
                                        <button class="icon-button delete-btn" data-id="@classItem.Id" data-handler="DeleteClass"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            }
                        } else { <p class="text-muted">No classes found.</p> }
                    } else { <p class="text-muted">Ensure Year, Semester, and Subject are selected.</p> }
                </div>
            </section>
            
            <section class="section-container" id="assign-section">
                <div class="section-header">
                    <h2>Assign Teacher</h2>
                </div>
                @if (Model.SelectedClassId > 0)
                {
                    <form method="post" asp-page-handler="AssignTeacher" class="p-2">
                        <input type="hidden" asp-for="Assignment.ClassId" value="@Model.SelectedClassId" />
                        <div class="mb-3">
                            <label class="form-label">Select Teacher</label>
                            <select class="form-control" asp-for="Assignment.TeacherId" asp-items="Model.TeacherOptions" required>
                                <option value="">-- Select Teacher --</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100"><i class="fa-solid fa-user-plus me-1"></i> Confirm Assignment</button>
                    </form>
                }
                else
                {
                    <p class="text-muted p-2">Select a Class Section above to assign a teacher.</p>
                }
            </section>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function showError(msg) {
            $('#js-error-text').text(msg);
            $('#js-error').removeClass('d-none');
            window.scrollTo(0, 0);
            setTimeout(() => $('#js-error').addClass('d-none'), 5000); // Auto hide
        }

        function validateYear(form) {
            const name = form.querySelector('input[name="YearName"]').value;
            const start = new Date(form.querySelector('input[name="DateStarted"]').value);
            const end = new Date(form.querySelector('input[name="DateEnded"]').value);

            if (!/^\d{4}-\d{4}$/.test(name)) { showError("Year must be YYYY-YYYY"); return false; }
            
            const parts = name.split('-');
            if (parseInt(parts[1]) !== parseInt(parts[0]) + 1) { showError("Year gap must be exactly 1 year."); return false; }
            
            if (start >= end) { showError("End Date must be after Start Date."); return false; }

            return true;
        }

        function validateDates(form) {
            const start = new Date(form.querySelector('input[name="DateStarted"]').value);
            const end = new Date(form.querySelector('input[name="DateEnded"]').value);
            if (start >= end) { showError("End Date must be after Start Date."); return false; }
            return true;
        }

        function validateText(form, fieldName) {
            const val = form.querySelector(`input[name="${fieldName}"]`).value.trim();
            if (val.length < 2) { showError("Name must be at least 2 characters."); return false; }
            return true;
        }

        $(document).ready(function () {
            function selectAndReload(id, type) {
                let y = $('.item-card[data-type="Year"].active').data('id') || 0;
                let s = $('.item-card[data-type="Semester"].active').data('id') || 0;
                let d = $('.item-card[data-type="Department"].active').data('id') || 0;
                let sub = $('.item-card[data-type="Subject"].active').data('id') || 0;
                let c = $('.item-card[data-type="Class"].active').data('id') || 0;

                if (type === 'Year') { y = id; s = sub = c = 0; } 
                else if (type === 'Semester') { s = id; sub = c = 0; }
                else if (type === 'Department') { d = id; sub = c = 0; }
                else if (type === 'Subject') { sub = id; c = 0; }
                else if (type === 'Class') { c = id; }

                window.location.href = `?SelectedYearId=${y}&SelectedSemesterId=${s}&SelectedDepartmentId=${d}&SelectedSubjectId=${sub}&SelectedClassId=${c}`;
            }

            $('.management-page').on('click', '.item-card', function(e) {
                if ($(e.target).closest('.icon-buttons').length || $(this).hasClass('editing')) return; 
                if (!$(this).hasClass('active')) selectAndReload($(this).data('id'), $(this).data('type'));
            });

            $('.add-btn').click(function() {
                $('.add-form-container').addClass('d-none');
                $(`#add-form-${$(this).data('type')}`).removeClass('d-none');
            });
            $('.cancel-add').click(function() { $(this).closest('.add-form-container').addClass('d-none'); });

            $('.edit-btn').click(function(e) {
                e.stopPropagation();
                var card = $(this).closest('.item-card');
                $('.item-card').removeClass('editing');
                card.addClass('editing');
            });
            $('.cancel-edit').click(function(e) {
                e.stopPropagation();
                $(this).closest('.item-card').removeClass('editing');
            });
            
            $('.delete-btn').click(function(e) {
                e.stopPropagation();
                if(confirm("Delete this item?")) {
                    const form = $('<form method="post"></form>').attr('action', '?handler=' + $(this).data('handler'));
                    form.append(`<input type="hidden" name="id" value="${$(this).data('id')}" />`);
                    $('body').append(form); form.submit();
                }
            });
        });
    </script>
}