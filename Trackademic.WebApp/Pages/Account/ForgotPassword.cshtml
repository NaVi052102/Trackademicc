@page
@model Trackademic.WebApp.Pages.Account.ForgotPasswordModel
@{
    ViewData["Title"] = "Forgot Password";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Trackademic</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/forgot-password.css" asp-append-version="true" />
</head>
<body class="account-page">

    <div class="reset-container">

        <a href="/Account/Login" class="back-link">
            <i class="bi bi-arrow-left"></i>
            Back to log-in page
        </a>

        <!-- STEP 1: EMAIL -->
        @if (Model.Step == 1)
        {
            <div class="reset-header">
                <h2>Forgot Password</h2>
                <p>Enter your email to receive a reset code.</p>
            </div>

            <div class="step-indicator">
                <div class="step-bar active"></div>
                <div class="step-bar"></div>
                <div class="step-bar"></div>
            </div>

            <form method="post" asp-page-handler="SendCode">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="mb-3">
                    <label asp-for="Input.Email" class="form-label">Email</label>
                    <input asp-for="Input.Email" class="form-control" placeholder="Enter your email" />
                    <span asp-validation-for="Input.Email" class="text-danger"></span>
                </div>
                <button type="submit" class="btn btn-trackademic-black">Reset password</button>
            </form>
        }

        <!-- STEP 2: VERIFY CODE -->
        @if (Model.Step == 2)
        {
            <div class="reset-header">
                <h2>Password Reset</h2>
                <p>We sent a code to your email.</p>
            </div>

            <div class="step-indicator">
                <div class="step-bar"></div>
                <div class="step-bar active"></div>
                <div class="step-bar"></div>
            </div>

            <form method="post" asp-page-handler="VerifyCode">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <span asp-validation-for="Input.Code" class="text-danger d-block mb-2 text-center"></span>

                <div class="mb-3">
                    <label class="form-label">Code</label>
                    <div class="code-inputs" id="code-container">
                        <input type="text" class="form-control code-input" maxlength="1" />
                        <input type="text" class="form-control code-input" maxlength="1" />
                        <input type="text" class="form-control code-input" maxlength="1" />
                        <input type="text" class="form-control code-input" maxlength="1" />
                        <input type="text" class="form-control code-input" maxlength="1" />
                        <input type="text" class="form-control code-input" maxlength="1" />
                    </div>
                    <!-- Hidden input to bind the 6 digits to the Model -->
                    <input type="hidden" asp-for="Input.Code" id="HiddenCodeInput" />
                </div>

                <button type="submit" class="btn btn-trackademic-black mt-3">Continue</button>
                <div class="text-center mt-3">
                    <small>Didn't receive the code? <a href="?Step=1">Try again</a></small>
                </div>
            </form>
        }

        <!-- STEP 3: RESET PASSWORD -->
        @if (Model.Step == 3)
        {
            <div class="reset-header">
                <h2>Set new password</h2>
                <p>Must be at least 8 characters.</p>
            </div>

            <div class="step-indicator">
                <div class="step-bar"></div>
                <div class="step-bar"></div>
                <div class="step-bar active"></div>
            </div>

            <form method="post" asp-page-handler="ResetPassword">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="mb-3">
                    <label asp-for="Input.NewPassword" class="form-label">New password</label>
                    <div class="input-group">
                        <input asp-for="Input.NewPassword" class="form-control" type="password" />
                        <button class="toggle-password" type="button">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                    <span asp-validation-for="Input.NewPassword" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Input.ConfirmPassword" class="form-label">Confirm new password</label>
                    <div class="input-group">
                        <input asp-for="Input.ConfirmPassword" class="form-control" type="password" />
                        <button class="toggle-password" type="button">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                    <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-trackademic-black mt-3">Reset Password</button>
            </form>
        }

    </div>

    <!-- SUCCESS MODAL -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-body p-4">
                    <div class="modal-icon" style="font-size: 3rem; color: green;">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h4 class="mt-2">Password Changed Successfully</h4>
                    <p class="text-muted small">You can now log in with your new password.</p>
                    <a href="/Account/Login" class="btn btn-trackademic-black mt-3 mb-2">
                        Confirm
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- IMPORTANT: Client-side validation scripts -->
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // Show success modal if server says Success = true
            @if (Model.Success)
            {
                    <text>
                    var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    </text>
            }

            // Handle the 6-digit code input logic
            const codeContainer = $('#code-container');
            const hiddenInput = $('#HiddenCodeInput'); // Matches ID in Step 2
            const inputs = codeContainer.find('.code-input');

            inputs.on('keyup', function (e) {
                const $this = $(this);
                const $next = $this.next('.code-input');

                // Move to next input automatically
                if (e.key >= 0 && e.key <= 9 && $this.val() && $next.length) {
                    $next.focus();
                }

                // Combine values into the hidden input
                let combinedCode = "";
                inputs.each(function () { combinedCode += $(this).val(); });
                hiddenInput.val(combinedCode);
            });

            inputs.on('keydown', function (e) {
                const $this = $(this);
                const $prev = $this.prev('.code-input');
                // Handle backspace
                if (e.key === 'Backspace' && !$this.val() && $prev.length) {
                    $prev.focus();
                }
            });

            // Toggle Password Visibility
            $(".toggle-password").on('click', function() {
                var icon = $(this).find('i');
                var input = $(this).prev('input');

                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                }
            });
        });
    </script>
</body>
</html>