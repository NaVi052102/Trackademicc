@page
@model Trackademic.WebApp.Pages.Teachers.GradesModel
@{
    Layout = "_TeachersLayout";
    ViewData["Title"] = "Grades";
}

<style>
    /* --- Layout --- */
    .grades-container { padding: 1.5rem; }

    /* --- Filter Bar --- */
    .grade-filter-bar {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .filter-group { display: flex; align-items: center; gap: 0.5rem; }
    .select-label { font-weight: 600; margin-right: 0.5rem; white-space: nowrap; color: #495057; }

    /* --- Buttons --- */
    .btn-apply-filters { background-color: #6c757d; border-color: #6c757d; color: #ffffff; }
    .btn-apply-filters:hover { background-color: #5a6268; border-color: #545b62; }
    
    .btn-save-all {
        background-color: #198754; /* Green for Teacher Save */
        border-color: #198754;
        color: white;
        min-width: 180px; font-weight: 600; border-radius: 50px;
    }
    .btn-save-all:hover { background-color: #157347; }

    /* --- Grade Sheet Table --- */
    .grade-list-table th {
        background-color: #6c757d;
        color: white;
        vertical-align: middle;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        text-align: center;
        padding: 12px 8px;
    }
    
    .grade-list-table td {
        vertical-align: middle;
        text-align: center;
        padding: 8px;
    }

    .grade-list-table .text-left { text-align: left; }

    /* --- Input Styling --- */
    .table-input {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 6px;
        font-size: 0.95rem;
        text-align: center;
        font-weight: 600;
        width: 100%;
        max-width: 80px;
        transition: all 0.2s;
    }
    
    .table-input:focus {
        border-color: #86b7fe;
        background-color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .table-readonly {
        background-color: transparent;
        border: none;
        color: #495057;
        font-weight: 500;
        cursor: default;
        text-align: left;
        padding-left: 0;
    }
    .table-readonly.text-center { text-align: center; }

    /* --- Grade Coloring --- */
    .grade-failing { color: #dc3545; } 
    .grade-passing { color: #198754; } 
    
    /* --- Status Dropdown --- */
    .status-select {
        font-weight: 700;
        font-size: 0.85rem;
        border-radius: 20px;
        padding: 4px 24px 4px 12px;
        width: auto;
        margin: 0 auto;
    }

    .search-input { min-width: 250px; }
</style>

<div class="grades-container">

    @* --- Filter Bar --- *@
    <div class="grade-filter-bar">
        
        @* Top Row: Academic Period *@
        <form method="get" class="d-flex flex-wrap align-items-center justify-content-between gap-3 border-bottom pb-3">
            <div class="d-flex flex-wrap gap-4">
                <div class="filter-group">
                    <label class="select-label">Year:</label>
                    <select asp-for="SchoolYear" asp-items="Model.SchoolYears" class="form-select" style="width: 120px;"></select>
                </div>
                <div class="filter-group">
                    <label class="select-label">Semester:</label>
                    <select asp-for="Semester" asp-items="Model.Semesters" class="form-select" style="width: 130px;"></select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-sm btn-apply-filters">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Context
            </button>
        </form>

        @* Bottom Row: Class Selection & Search (Removed Subject Dropdown) *@
        <form method="get" class="d-flex flex-wrap align-items-center gap-3">
            @* Hidden fields to preserve top row state *@
            <input type="hidden" asp-for="SchoolYear" />
            <input type="hidden" asp-for="Semester" />

            <div class="filter-group flex-grow-1">
                <label class="select-label">Class:</label>
                <select asp-for="ClassId" asp-items="Model.AvailableClasses" class="form-select w-100" onchange="this.form.submit()">
                    <option value="">-- Select Class --</option>
                </select>
            </div>

            <div class="input-group search-input">
                <input type="text" asp-for="SearchTerm" class="form-control" placeholder="Search Student...">
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i></button>
            </div>
        </form>
    </div>

    @* --- Grade Sheet Table --- *@
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 text-dark">
                <i class="bi bi-journal-bookmark-fill me-2"></i> 
                @* Subject info is now derived from the selected Class *@
                @if(!string.IsNullOrEmpty(Model.SubjectDisplayCode)) { 
                    <span class="text-primary fw-bold">@Model.SubjectDisplayCode</span> <span>- @Model.SubjectDescription</span>
                } else { 
                    <span>Grade Sheet</span> 
                }
            </h5>
            <small class="text-muted fw-bold">@Model.SelectedTermDisplay</small>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <form method="post" asp-page-handler="UpdateAll">
                    @* Preserve filters for postback *@
                    <input type="hidden" asp-for="SchoolYear" />
                    <input type="hidden" asp-for="Semester" />
                    <input type="hidden" asp-for="ClassId" />
                    <input type="hidden" asp-for="SearchTerm" />

                    <table class="table table-hover mb-0 grade-list-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 110px;">ID Number</th>
                                <th class="text-left">Student Name</th>
                                <th style="width: 90px;">Program</th>
                                <th style="width: 90px;">Midterm</th>
                                <th style="width: 90px;">Final</th>
                                <th style="width: 90px;">Final Grade</th>
                                <th style="width: 120px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Grades.Any())
                            {
                                @for (int i = 0; i < Model.Grades.Count; i++)
                                {
                                    var g = Model.Grades[i];
                                    string statusClass = g.Status == "FAILED" ? "status-fail" : (g.Status == "PASSED" ? "status-pass" : "status-inc");
                                    string gradeColor = g.FinalGrade >= 5.0 ? "grade-failing" : (g.FinalGrade > 0 && g.FinalGrade <= 3.0 ? "grade-passing" : "");

                                    <tr>
                                        <td class="text-muted">@(i + 1)</td>
                                        <input type="hidden" asp-for="Grades[i].Id" />

                                        <td>
                                            <input asp-for="Grades[i].StudentIdNumber" class="table-readonly text-center w-100" readonly />
                                        </td>
                                        <td class="text-left">
                                            <input asp-for="Grades[i].StudentName" class="table-readonly w-100 text-start" readonly />
                                        </td>
                                        <td>
                                            <input asp-for="Grades[i].Program" class="table-readonly text-center w-100" readonly />
                                        </td>

                                        <td>
                                            <input asp-for="Grades[i].Midterm" class="table-input" placeholder="-" />
                                        </td>
                                        <td>
                                            <input asp-for="Grades[i].Final" class="table-input" placeholder="-" />
                                        </td>
                                        <td>
                                            <input asp-for="Grades[i].FinalGrade" type="number" step="0.1" class="table-input @gradeColor" placeholder="0.0" />
                                        </td>
                                        <td>
                                            <select asp-for="Grades[i].Status" class="form-select form-select-sm status-select @statusClass">
                                                <option value="PASSED" class="text-success fw-bold">PASSED</option>
                                                <option value="FAILED" class="text-danger fw-bold">FAILED</option>
                                                <option value="INC" class="text-warning fw-bold">INC</option>
                                                <option value="DROPPED" class="text-muted">DROPPED</option>
                                            </select>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>
                                        No students found in this class.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    @if (Model.Grades.Any())
                    {
                        <div class="card-footer bg-white p-3 text-end border-top-0">
                            <button type="submit" class="btn btn-save-all shadow-sm">
                                <i class="bi bi-check-lg me-2"></i> Save Grades
                            </button>
                        </div>
                    }
                </form>
            </div>
        </div>
    </div>
</div>