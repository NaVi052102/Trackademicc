@page
@model Trackademic.Pages.Student.StudentDashboardModel
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/student-dashboard.css" asp-append-version="true" />
}

<div class="dashboard-full-width-container">

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="dashboard-title-wrapper">
            <h2>Welcome Back, Student!</h2>
            <p class="text-muted">Quick overview of your academic status and enrolled courses.</p>
        </div>

        <div class="dashboard-header-right-match">
            <div class="search-bar">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" placeholder="Search for a class or subject...">
            </div>

            <a id="notification-toggle" class="btn btn-link text-secondary fs-4 p-0 notification-bell" title="Grade Alerts">
                <i class="bi bi-bell @(Model.PerformanceAlerts.Any() ? "bell-active" : "")"></i>
                @if (Model.PerformanceAlerts.Any())
                {
                    <span class="badge rounded-pill bg-danger notification-count">
                        @Model.PerformanceAlerts.Count
                    </span>
                }
            </a>
        </div>
    </div>

    @* --- 1. ACADEMIC SUMMARY CARDS --- *@
    <div class="row mb-5 d-flex dashboard-summary-container">

        <div class="col-md-3">
            <div class="dashboard-summary-card card-gpa card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-star-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Cumulative GPA/GWA</div>
                    <div class="dashboard-value-lg">@Model.CumulativeGPA.ToString("0.00")</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-units card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-list-ol display-5 mb-2"></i>
                    <div class="summary-card-title">Total Units Earned</div>
                    <div class="dashboard-value-lg">@Model.TotalUnitsEarned</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-passed card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-check-circle-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Subjects Passed</div>
                    <div class="dashboard-value-lg">@Model.PassedSubjects / @Model.TotalSubjects</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-failed-status card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-x-circle-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Subjects Failed</div>
                    <div class="dashboard-value-lg">@(Model.TotalSubjects - Model.PassedSubjects)</div>
                </div>
            </div>
        </div>
    </div>

    @* --- 2. GPA HISTORY & CURRENT PERFORMANCE (NEW SECTION) --- *@
    <div class="row mb-5 dashboard-main-content">

        @* 2a. GPA History Bar Graph (Left Column) *@
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 p-3">
                <h3 class="card-title mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>GPA History</h3>
                <div class="card-body p-0 d-flex flex-column justify-content-end">
                    @if (Model.GpaHistory.Any())
                    {
                        <div class="gpa-bar-chart">
                            @foreach (var entry in Model.GpaHistory)
                            {
                                var barHeight = (int)((entry.Value / 5.0m) * 100);
                                var barColor = entry.Value >= 4.0m ? "gpa-bar-green" : (entry.Value >= 3.0m ? "gpa-bar-yellow" : "gpa-bar-red");

                                <div class="gpa-bar-wrapper" title="GPA @entry.Value.ToString("0.00")">
                                    <div class="gpa-bar @barColor" style="height: @(barHeight)%;">
                                        <span class="gpa-value">@entry.Value.ToString("0.00")</span>
                                    </div>
                                    <div class="gpa-label">@entry.Key</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-5">No GPA history available.</p>
                    }
                </div>
            </div>
        </div>

        @* 2b. Current Semester Performance (Right Column) *@
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 p-3">
                <h3 class="card-title mb-3"><i class="bi bi-bullseye me-2 text-success"></i>Current Semester Performance</h3>
                <div class="card-body performance-list p-0">
                    @if (Model.PerformanceData.Any())
                    {
                        <ul class="list-unstyled">
                            @foreach (var perf in Model.PerformanceData)
                            {
                                string progressClass;
                                if (perf.Percentage >= 75)
                                {
                                    progressClass = "bg-success";
                                }
                                else if (perf.Percentage >= 60)
                                {
                                    progressClass = "bg-warning";
                                }
                                else
                                {
                                    progressClass = "bg-danger";
                                }

                                <li class="performance-item">
                                    <div class="subject-info">
                                        <strong>@perf.SubjectCode</strong> - <span class="text-muted">@perf.Description</span>
                                    </div>
                                    <div class="progress-wrapper">
                                        <div class="progress performance-progress">
                                            <div class="progress-bar @progressClass" role="progressbar" style="width: @(perf.Percentage)%;" aria-valuenow="@perf.Percentage" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="progress-text @(perf.Percentage >= 70 ? "text-white" : "text-dark")">@perf.Percentage%</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted text-center py-5">No current semester performance data available.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    @* --- 3. ALL ENROLLED CLASSES (CARD GRID) --- *@
    <div class="mb-4">
        <h3 class="mb-3"><i class="bi bi-archive-fill me-2"></i> All Enrolled Classes</h3>
    </div>

    <div class="class-grid-dashboard">
        @if (Model.EnrolledClasses.Any())
        {
            @foreach (var cls in Model.EnrolledClasses)
            {
                <div class="class-card-dashboard">
                    <div class="class-card-content">
                        <img src="@cls.ImageUrl" alt="@cls.Description" class="class-card-image" />
                        <div class="class-card-info">
                            <h5>@cls.SubjectCode - @cls.Description</h5>
                            <p>@cls.Units Units &bull; @cls.FacultyName</p>
                        </div>
                    </div>
                    <div class="class-card-footer">
                        <a href="#">View Details / Grades</a>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted text-center py-4">No classes found for this academic history.</p>
        }
    </div>

    @* --- NOTIFICATION POPUP BOX (Hidden by default) --- *@
    <div id="notification-popup" class="notification-popup-box card shadow-lg">
        <div class="card-header bg-white"><i class="bi bi-bell-fill me-2 text-danger"></i> **Action Required Alerts**</div>
        <div class="card-body p-2">
            @if (Model.PerformanceAlerts.Any())
            {
                <ul class="list-unstyled mb-0 small">
                    @foreach (var alert in Model.PerformanceAlerts)
                    {
                        <li class="p-1 mb-1 alert-item">@Html.Raw(alert)</li>
                    }
                </ul>
                <div class="text-center mt-2">
                    <a href="#" class="btn btn-sm btn-view-alert">View Details</a>
                </div>
            }
            else
            {
                <p class="text-muted small m-0">No immediate grade alerts.</p>
            }
        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // JS for Notification Pop-up Toggle (Retained)
        document.getElementById('notification-toggle').addEventListener('click', function(event) {
            var popup = document.getElementById('notification-popup');
            var isVisible = popup.style.display === 'block';
            popup.style.display = isVisible ? 'none' : 'block';
            event.stopPropagation();
        });

        document.addEventListener('click', function(event) {
            var popup = document.getElementById('notification-popup');
            var toggle = document.getElementById('notification-toggle');
            if (popup.style.display === 'block' && !popup.contains(event.target) && !toggle.contains(event.target)) {
                popup.style.display = 'none';
            }
        });
        document.getElementById('notification-popup').style.display = 'none';
    </script>
}