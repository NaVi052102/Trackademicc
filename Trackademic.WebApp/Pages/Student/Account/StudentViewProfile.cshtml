using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Linq;
using System;
using Trackademic.Core.Interfaces; // Assuming this namespace exists
using Trackademic.Core.Models;     // Assuming this namespace exists

namespace Trackademic.Pages.Student
{
    // Class definition for the Enrolled Classes list
    public class ClassEnrollmentDisplay
    {
        public string SubjectCode { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string FacultyName { get; set; } = string.Empty;
        public int Units { get; set; } = 0;
        public string ImageUrl { get; set; } = "/images/logo.png";
    }

    public class StudentDashboardModel : PageModel
    {
        private readonly IGradeService _gradeService;

        public StudentDashboardModel(IGradeService gradeService)
        {
            _gradeService = gradeService;
        }

        // --- PROPERTIES REQUIRED BY THE RAZOR VIEW (Initialized) ---

        public decimal CumulativeGPA { get; set; } = 0.0m;
        public int TotalUnitsEarned { get; set; } = 0;
        public int PassedSubjects { get; set; } = 0;
        public int TotalSubjects { get; set; } = 0;

        public List<string>
    PerformanceAlerts { get; set; } = new();
    public Dictionary<string, decimal>
        GpaHistory { get; set; } = new();
        public List<ClassEnrollmentDisplay>
            EnrolledClasses { get; set; } = new();

            // --- PAGE HANDLER AND LOGIC ---

            public void OnGet()
            {
            LoadCurrentTermClasses();
            LoadGpaHistory();
            CalculateCumulativeStatistics();
            GeneratePerformanceAlerts();
            }

            private void LoadCurrentTermClasses()
            {
            // MOCK DATA for Enrolled Classes
            EnrolledClasses = new List<ClassEnrollmentDisplay>
                {
                new ClassEnrollmentDisplay { SubjectCode = "CPE331", Description = "Data and Digital Communications", FacultyName = "SEMBLANTE, J. N.", Units = 3 },
                new ClassEnrollmentDisplay { SubjectCode = "CPE361", Description = "Logic Circuits and Design", FacultyName = "CORTES, S. G.", Units = 4 },
                new ClassEnrollmentDisplay { SubjectCode = "ES038", Description = "Technopreneurship", FacultyName = "BARRIOQUINTO, E. M.", Units = 3 },
                new ClassEnrollmentDisplay { SubjectCode = "CPE333", Description = "Basic Safety and Health", FacultyName = "ALFEREZ, N.", Units = 3 },
                new ClassEnrollmentDisplay { SubjectCode = "CPE335", Description = "Feedback and Control Systems", FacultyName = "TAMPUS, M. J.", Units = 3 },
                };
                }

                private void CalculateCumulativeStatistics()
                {
                // MOCK Cumulative Data
                CumulativeGPA = 4.12m;
                TotalUnitsEarned = 78;
                PassedSubjects = 18;
                TotalSubjects = 20;
                }


                private void LoadGpaHistory()
                {
                // MOCK GPA HISTORY
                GpaHistory = new Dictionary<string, decimal>
                    {
                    { "Spr '23", 3.75m },
                    { "Fall '23", 3.90m },
                    { "Spr '24", 4.05m },
                    { "Fall '24", 4.12m }
                    };
                    }

                    private void GeneratePerformanceAlerts()
                    {
                    // MOCK Alert Generation logic
                    var historicalGrades = new List<(string code, string status)>
                        {
                        ("CPE335", "FAILED"),
                        ("CPE101", "INC"),
                        ("MAT201", "FAILED"),
                        };

                        foreach (var grade in historicalGrades)
                        {
                        if (grade.status == "FAILED")
                        {
                        PerformanceAlerts.Add($"<i class='bi bi-x-octagon-fill text-danger me-1'></i> **FAILED:** Subject {grade.code} (Action required).");
                        }
                        else if (grade.status == "INC")
                        {
                        PerformanceAlerts.Add($"<i class='bi bi-exclamation-triangle-fill text-warning me-1'></i> **INCOMPLETE:** Subject {grade.code} (Submit pending requirements).");
                        }
                        }
                        }
                        }
                        }
