@page
@model Trackademic.Pages.Student.StudentDashboardModel
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/student-dashboard.css" asp-append-version="true" />
}

<div class="dashboard-full-width-container">

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="dashboard-title-wrapper">
            <h2>Welcome Back, Student!</h2>
            <p class="text-muted">Quick overview of your academic status and enrolled courses.</p>
        </div>

        <div class="dashboard-header-right-match">
            <div class="search-bar">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" placeholder="Search for a class or subject...">
            </div>
        </div>
    </div>

    @* --- 1. ACADEMIC SUMMARY CARDS --- *@
    <div class="row mb-5 d-flex dashboard-summary-container">

        <div class="col-md-3">
            <div class="dashboard-summary-card card-gpa card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-star-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Cumulative GPA/GWA</div>
                    <div class="dashboard-value-lg">@Model.CumulativeGPA.ToString("0.00")</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-units card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-list-ol display-5 mb-2"></i>
                    <div class="summary-card-title">Total Units Earned</div>
                    <div class="dashboard-value-lg">@Model.TotalUnitsEarned</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-passed card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-check-circle-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Subjects Passed</div>
                    <div class="dashboard-value-lg">@Model.PassedSubjects / @Model.TotalSubjects</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="dashboard-summary-card card-failed-status card-small-size">
                <div class="dashboard-card-inner">
                    <i class="bi bi-x-circle-fill display-5 mb-2"></i>
                    <div class="summary-card-title">Subjects Failed</div>
                    <div class="dashboard-value-lg">@(Model.TotalSubjects - Model.PassedSubjects)</div>
                </div>
            </div>
        </div>
    </div>

    @* --- 2. GPA HISTORY & CURRENT PERFORMANCE (NEW SECTION) --- *@
    <div class="row mb-5 dashboard-main-content">

        @* 2a. GPA History Bar Graph (Left Column) *@
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 p-3">
                <h3 class="card-title mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>GPA History</h3>
                <div class="card-body p-0 d-flex flex-column justify-content-end">
                    @if (Model.GpaHistory.Any())
                    {
                        <div class="gpa-bar-chart">
                            @foreach (var entry in Model.GpaHistory)
                            {
                                var barHeight = (int)((entry.Value / 5.0m) * 100);
                                var barColor = entry.Value >= 4.0m ? "gpa-bar-green" : (entry.Value >= 3.0m ? "gpa-bar-yellow" : "gpa-bar-red");

                                <div class="gpa-bar-wrapper" title="GPA @entry.Value.ToString("0.00")">
                                    <div class="gpa-bar @barColor" style="height: @(barHeight)%;">
                                        <span class="gpa-value">@entry.Value.ToString("0.00")</span>
                                    </div>
                                    <div class="gpa-label">@entry.Key</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-5">No GPA history available.</p>
                    }
                </div>
            </div>
        </div>

        @* 2b. Current Semester Performance (Right Column) *@
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 p-3">
                <h3 class="card-title mb-3"><i class="bi bi-bullseye me-2 text-success"></i>Current Semester Performance</h3>
                <div class="card-body performance-list p-0">
                    @if (Model.PerformanceData.Any())
                    {
                        <ul class="list-unstyled">
                            @foreach (var perf in Model.PerformanceData)
                            {
                                string progressClass;
                                if (perf.Percentage >= 75)
                                {
                                    progressClass = "bg-success";
                                }
                                else if (perf.Percentage >= 60)
                                {
                                    progressClass = "bg-warning";
                                }
                                else
                                {
                                    progressClass = "bg-danger";
                                }

                                <li class="performance-item">
                                    <div class="subject-info">
                                        <strong>@perf.SubjectCode</strong> - <span class="text-muted">@perf.Description</span>
                                    </div>
                                    <div class="progress-wrapper">
                                        <div class="progress performance-progress">
                                            <div class="progress-bar @progressClass" role="progressbar" style="width: @(perf.Percentage)%;" aria-valuenow="@perf.Percentage" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="progress-text @(perf.Percentage >= 70 ? "text-white" : "text-dark")">@perf.Percentage%</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted text-center py-5">No current semester performance data available.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    @* --- 3. ALL ENROLLED CLASSES (CARD GRID) --- *@
    <div class="mb-4">
        <h3 class="mb-3"><i class="bi bi-archive-fill me-2"></i> All Enrolled Classes</h3>
    </div>

    <div class="class-grid-dashboard">
        @if (Model.EnrolledClasses.Any())
        {
            @foreach (var cls in Model.EnrolledClasses)
            {
                <div class="class-card-dashboard"
                     onclick="showClassDetailsModal(this)"
                     data-code="@cls.SubjectCode"
                     data-description="@cls.Description"
                     data-faculty="@cls.FacultyName"
                     data-units="@cls.Units"
                     data-image="@cls.ImageUrl">
                    <div class="class-card-content">
                        <img src="@cls.ImageUrl" alt="@cls.Description" class="class-card-image" />
                        <div class="class-card-info">
                            <h5>@cls.SubjectCode - @cls.Description</h5>
                            <p>@cls.Units Units &bull; @cls.FacultyName</p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted text-center py-4">No classes found for this academic history.</p>
        }
    </div>

</div>

<div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSubjectCode"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center mb-3">
                    <img id="modalSubjectImage" src="" alt="Subject Image" class="class-card-image me-3" style="width: 80px; height: 80px;" />
                    <div>
                        <h4 id="modalDescription"></h4>
                        <p class="text-muted mb-1"><i class="bi bi-person-fill me-2"></i> <span id="modalFacultyName"></span></p>
                        <p class="text-muted mb-0"><i class="bi bi-book-fill me-2"></i> <span id="modalUnits"></span> Units</p>
                    </div>
                </div>

                <hr />

                <h6 class="mb-3">Quick Access</h6>
                <div class="d-flex justify-content-start gap-3 mb-3">
                    <a href="#" class="btn btn-outline-secondary btn-sm"><i class="bi bi-journal-check me-1"></i> Grades</a>
                </div>

                <h6 class="mb-3">Student Roster</h6>
                <div class="search-bar mb-3">
                    <i class="bi bi-search"></i>
                    <input type="text" id="dashboardStudentSearchInput" class="form-control" placeholder="Search students by name or ID">
                </div>

                <div id="studentListContainer" style="max-height: 250px; overflow-y: auto;">
                    <ul class="list-group" id="dashboardStudentList">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            John Doe
                            <span class="badge bg-primary rounded-pill">ID: 20210001</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Jane Smith
                            <span class="badge bg-primary rounded-pill">ID: 20210002</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Robert Green
                            <span class="badge bg-primary rounded-pill">ID: 20210003</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Alice Johnson
                            <span class="badge bg-primary rounded-pill">ID: 20210004</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Bob Williams
                            <span class="badge bg-primary rounded-pill">ID: 20210005</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Charlie Brown
                            <span class="badge bg-primary rounded-pill">ID: 20210006</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Diana Prince
                            <span class="badge bg-primary rounded-pill">ID: 20210007</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // JS function to handle the click and display the class details modal
        function showClassDetailsModal(cardElement) {
            // 1. Get data attributes from the clicked card
            const code = cardElement.getAttribute('data-code');
            const description = cardElement.getAttribute('data-description');
            const faculty = cardElement.getAttribute('data-faculty');
            const units = cardElement.getAttribute('data-units');
            const image = cardElement.getAttribute('data-image');

            // 2. Update the modal content
            document.getElementById('modalSubjectCode').innerText = code;
            document.getElementById('modalDescription').innerText = description;
            document.getElementById('modalFacultyName').innerText = faculty;
            document.getElementById('modalUnits').innerText = units;
            document.getElementById('modalSubjectImage').src = image;

            // 3. Show the modal
            var classDetailsModal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
            classDetailsModal.show();
        }

        // Student Search/Filter functionality (Client-Side for the Dashboard Modal)
        document.getElementById('dashboardStudentSearchInput').addEventListener('keyup', function() {
            const filter = this.value.toUpperCase();
            const ul = document.getElementById('dashboardStudentList');
            const li = ul.getElementsByTagName('li');

            // Loop through all list items, and hide those that don't match the search query
            for (let i = 0; i < li.length; i++) {
                const text = li[i].textContent || li[i].innerText;
                if (text.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = ""; // Show
                } else {
                    li[i].style.display = "none"; // Hide
                }
            }
        });
    </script>
}